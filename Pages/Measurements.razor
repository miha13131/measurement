@page "/measurements"
@inject HttpClient Http
@inject IJSRuntime JS
@using DeviceMeasurementsApp.Services
@using DeviceMeasurementsApp.Models

<h3>Measurements</h3>

<button @onclick="Load">Load SMY134aEMIx.cea</button>
<p>@status</p>

@if (store != null)
{
    <h4>OBJECT</h4>

    @foreach (var r in recs)
    {
        <button style="margin-right:6px;" @onclick="() => SelectRec(r.Id)">
            @r.Name
        </button>
    }
}

@if (table != null)
{
    <h4>Table</h4>

    <div style="overflow:auto; max-height:300px; border:1px solid #ddd;">
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Time</th>
                    @foreach (var c in table.Columns)
                    {
                        <th>@c.DisplayName</th>
                    }
                </tr>
            </thead>
            <tbody>
                @for (int i = 0; i < table.Rows.Count; i++)
                {
                    <tr>
                        <td>@table.Time[i].ToString("HH:mm")</td>
                        @for (int c = 0; c < Math.Min(table.Columns.Count, table.Rows[i].Length); c++)
                        {
                            <td>@table.Rows[i][c].ToString("0.###")</td>
                        }

                    </tr>
                }
            </tbody>
        </table>
    </div>

    <h4>Chart</h4>

    <label>Column:</label>
    <select @onchange="OnColumnChanged">
        @for (int i = 0; i < table.Columns.Count; i++)
        {
            <option value="@i" selected="@(i == selectedColumn)">
                @table.Columns[i].DisplayName
            </option>
        }
    </select>

    <div style="height:400px; margin-top:10px;">
        <canvas id="chartCanvas"></canvas>
    </div>
}

@code {
    record Rec(int Id, string Name);

    List<Rec> recs = new()
    {
        new(58, "EMI1"),
        new(60, "EMI2"),
        new(59, "EMI3"),
        new(1,  "MAIN")
    };

    string status = "Waiting…";

    CeaZipStore? store;
    UniArchTable? table;

    int selectedColumn = 1;

    async Task Load()
    {
        store = await CeaZipStore.LoadAsync(Http, "sample-data/SMY134aEMIx.cea");
        table = null;
        status = "Loaded. Select an object.";
    }

    async Task SelectRec(int recId)
    {
        if (store == null) return;

        var archId = store.GetArchIds(recId).First();
        var pack = store.GetBinPacks(recId, archId).First();

        var bytes = store.Read(pack.Entry);

        var typeXml = store.ReadArchDefXml();
        var columns = ArchDefParser.ParseColumns(typeXml);

        table = UniArchTableParser.ParseMinuteTable(
            bytes,
            pack.TimeUtc.ToLocalTime(),
            periodMs: 60000,
            maxRows: 500
        );

        // ВОТ ЭТА СТРОКА КЛЮЧЕВАЯ
        table.Columns.Clear();
        table.Columns.AddRange(columns);


        selectedColumn = 1;

        status = $"Loaded {pack.TimeUtc:O}";
        await DrawChart();
    }

    async Task OnColumnChanged(ChangeEventArgs e)
    {
        selectedColumn = int.Parse(e.Value!.ToString()!);
        await DrawChart();
    }

    async Task DrawChart()
    {
        if (table == null) return;

        var points = table.Time
            .Zip(table.Rows, (t, r) => new
            {
                x = t,                      // DateTime напрямую
                y = (double)r[selectedColumn]
            })
            .ToArray();

        await JS.InvokeVoidAsync(
            "chartInterop.renderTimeSeriesChart",
            "chartCanvas",
            points,
            table.Columns[selectedColumn].DisplayName
        );
    }

}
